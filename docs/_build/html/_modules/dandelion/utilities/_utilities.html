

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>dandelion.utilities._utilities &mdash; dandelion 0.0.27.post1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/dandelion_logo.png"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/dandelion_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#required-database">Required database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#external-softwares">External softwares</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#basic-requirements">Basic requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#acknowledgements">Acknowledgements</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/1_dandelion_preprocessing-10x%20data.html">Pre-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/2_dandelion_filtering-10x%20data.html">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/3_dandelion_findingclones_and_analysis-10x%20data.html">BCR clustering and visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/5_dandelion_running_from_R.html">Running from R</a></li>
</ul>
<p class="caption"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Preprocessing: <cite>pp</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.preprocessing.external">Preprocessing (external): <cite>pp.external</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.tools">Tools: <cite>tl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.plotting">Plotting: <cite>pl</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html#module-dandelion.utilities">Utilities: <cite>utl</cite></a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dandelion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>dandelion.utilities._utilities</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dandelion.utilities._utilities</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># @Author: kt16</span>
<span class="c1"># @Date:   2020-05-12 14:01:32</span>
<span class="c1"># @Last Modified by:   Kelvin</span>
<span class="c1"># @Last Modified time: 2020-12-30 01:53:19</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">changeo.IO</span> <span class="kn">import</span> <span class="n">readGermlines</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">import</span> <span class="nn">tables</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">_pickle</span> <span class="k">as</span> <span class="nn">cPickle</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scanpy</span> <span class="kn">import</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">logg</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Tree</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create a recursive defaultdict</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Tree</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">Tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">fasta_iterator</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read in a fasta file as an iterator</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">sequence</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">yield</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span>

<span class="k">def</span> <span class="nf">Write_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    general line writer</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">dict_from_table</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a dictionary from a dataframe</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    meta</span>
<span class="sd">        pandas dataframe or file path</span>
<span class="sd">    columns</span>
<span class="sd">        column names in dataframe</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">meta_</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sample_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">meta_</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">meta_</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">meta</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">meta_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sample_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">meta_</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">meta_</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>

    <span class="n">sample_dict</span> <span class="o">=</span> <span class="n">clean_nan_dict</span><span class="p">(</span><span class="n">sample_dict</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sample_dict</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">clean_nan_dict</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d</span>
<span class="sd">        dictionary</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dictionary with no NAs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span><span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    l</span>
<span class="sd">        list</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    a flattened list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="k">yield from</span> <span class="n">flatten</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">el</span>

<div class="viewcode-block" id="makeblastdb"><a class="viewcode-back" href="../../../modules/dandelion.utilities.makeblastdb.html#dandelion.utilities.makeblastdb">[docs]</a><span class="k">def</span> <span class="nf">makeblastdb</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs makeblastdb.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref</span>
<span class="sd">        fasta file</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;makeblastdb&#39;</span><span class="p">,</span>
               <span class="s1">&#39;-dbtype&#39;</span><span class="p">,</span> <span class="s1">&#39;nucl&#39;</span><span class="p">,</span>
               <span class="s1">&#39;-parse_seqids&#39;</span><span class="p">,</span>
               <span class="s1">&#39;-in&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">]</span>
    <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">bh</span><span class="p">(</span><span class="n">pvalues</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the Benjamini-Hochberg FDR correction.</span>

<span class="sd">    Input:</span>
<span class="sd">        * pvals - vector of p-values to correct</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pvalues</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">new_pvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">pvalue</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pvalues</span><span class="p">)</span> <span class="p">]</span>
    <span class="n">values</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">values</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">new_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">i</span>
        <span class="n">pvalue</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">vals</span>
        <span class="n">new_values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="o">/</span><span class="n">rank</span><span class="p">)</span> <span class="o">*</span> <span class="n">pvalue</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">new_values</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">new_values</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
        <span class="n">pvalue</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">vals</span>
        <span class="n">new_pvalues</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_pvalues</span>

<span class="c1"># def extract(d, keys):</span>
<span class="c1">#    return(dict((k, d[k]) for k in keys if k in d))</span>

<div class="viewcode-block" id="load_data"><a class="viewcode-back" href="../../../modules/dandelion.utilities.load_data.html#dandelion.utilities.load_data">[docs]</a><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in or copy dataframe object and set sequence_id as index without dropping.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : DataFrame, str</span>
<span class="sd">        file path to .tsv file or pandas DataFrame object.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas DataFrame object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">obj_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Either input is not of &lt;class &#39;pandas.core.frame.DataFrame&#39;&gt; or file does not exist.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;sequence_id&#39;</span> <span class="ow">in</span> <span class="n">obj_</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">obj_</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;&#39;sequence_id&#39; not found in columns of input&quot;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">obj_</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">setup_metadata_</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Dandelion class subfunction to initialize the `.metadata` slot.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : DataFrame</span>
<span class="sd">        pandas DataFrame object.    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas DataFrame object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dat_h</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dict_h</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_h</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="n">dat_h</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]))</span>
    <span class="n">metadata_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dict_h</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
    <span class="n">metadata_</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">metadata_</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setup_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">clone_key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Dandelion class subfunction to initialize the `.metadata` slot.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : DataFrame</span>
<span class="sd">        pandas DataFrame object.</span>
<span class="sd">    clone_key : str, optiona;</span>
<span class="sd">        column name of clone id. None defaults to &#39;clone_id&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas DataFrame object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">clone_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clonekey</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clonekey</span> <span class="o">=</span> <span class="n">clone_key</span>

    <span class="n">dat_h</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dat_l</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dat_l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">clone_h</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_h</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dat_h</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">],</span> <span class="n">dat_h</span><span class="p">[</span><span class="n">clonekey</span><span class="p">])))</span>
        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">clone_h</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;heavy&#39;</span><span class="p">])</span>
        <span class="n">metadata_</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">clones_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metadata_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:])))</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">cl</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">clones_list</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">clones_list</span><span class="p">)</span>
        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">metadata_</span><span class="p">[[</span><span class="n">clonekey</span><span class="p">]]</span>
        
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span>
        <span class="n">clone_size</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">clonesize_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">clone_size</span><span class="p">)</span>

        <span class="c1"># size_of_clone = pd.DataFrame(metadata_[str(clonekey)].value_counts())</span>
        <span class="n">size_of_clone</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">clonesize_dict</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">size_of_clone</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">size_of_clone</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">),</span> <span class="s1">&#39;clone_size&#39;</span><span class="p">]</span>    
        <span class="n">size_of_clone</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_of_clone</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">size_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">size_of_clone</span><span class="p">[</span><span class="s1">&#39;clone_id&#39;</span><span class="p">],</span> <span class="n">size_of_clone</span><span class="p">[</span><span class="s1">&#39;clone_id_by_size&#39;</span><span class="p">]))</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">size_dict</span><span class="p">[</span><span class="n">c_</span><span class="p">])</span> <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">size_dict</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]]</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">metadata_</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clone_h</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_h</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dat_h</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">],</span> <span class="n">dat_h</span><span class="p">[</span><span class="n">clonekey</span><span class="p">])))</span>
        <span class="n">clone_l</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_l</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dat_l</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">],</span> <span class="n">dat_l</span><span class="p">[</span><span class="n">clonekey</span><span class="p">])))</span>
        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">clone_h</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;heavy&#39;</span><span class="p">])</span>
        <span class="n">metadata_</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">light_clone_tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clone_l</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">light_clone_tree</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">light_clone_tree2</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">light_clone_tree</span><span class="p">:</span>
            <span class="n">second_key</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="n">light_clone_tree</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">second_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
            <span class="n">second_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">second_key</span><span class="p">))</span>
            <span class="n">second_key_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">second_key</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">second_key</span><span class="p">))))</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">light_clone_tree</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">light_clone_tree2</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">second_key_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="s1">&#39;light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">light_clone_tree2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">else</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">[</span><span class="s1">&#39;light&#39;</span><span class="p">]])</span>
        <span class="n">tmp_dat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">tmp_dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;light_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tmp_dat</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_dat</span><span class="p">,</span> <span class="n">left_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">metadata_</span><span class="p">[[</span><span class="s1">&#39;heavy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tmp_dat</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
        <span class="n">clones_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metadata_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:])))</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">cl</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">clones_list</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="n">clonekey</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">clones_list</span><span class="p">)</span>
        <span class="n">metadata_</span> <span class="o">=</span> <span class="n">metadata_</span><span class="p">[[</span><span class="n">clonekey</span><span class="p">]]</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span>
        <span class="n">clone_size</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">clonesize_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">clone_size</span><span class="p">)</span>

        <span class="c1"># size_of_clone = pd.DataFrame(metadata_[str(clonekey)].value_counts())</span>
        <span class="n">size_of_clone</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">clonesize_dict</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">size_of_clone</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">size_of_clone</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">),</span> <span class="s1">&#39;clone_size&#39;</span><span class="p">]</span>
        <span class="n">size_of_clone</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_of_clone</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">size_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">size_of_clone</span><span class="p">[</span><span class="s1">&#39;clone_id&#39;</span><span class="p">],</span> <span class="n">size_of_clone</span><span class="p">[</span><span class="s1">&#39;clone_id_by_size&#39;</span><span class="p">]))</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">size_dict</span><span class="p">[</span><span class="n">c_</span><span class="p">])</span> <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">size_dict</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)]]</span>
        <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">metadata_</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">retrieve_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">retrieve_id</span><span class="p">,</span> <span class="n">split_heavy_light</span><span class="p">,</span> <span class="n">collapse</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Dandelion class subfunction to populate the `.metadata` slot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : DataFrame</span>
<span class="sd">        pandas DataFrame object.</span>
<span class="sd">    retrieve_id : str</span>
<span class="sd">        column name in `.data` slot.</span>
<span class="sd">    split_heavy_light : bool</span>
<span class="sd">        Returns the retrieval splitted into two column for heavy and light. Default is True. False combines the retrieval into a single column.</span>
<span class="sd">    collapse : bool</span>
<span class="sd">        Whether or not to collapse unique elements if duplicated. For example, different contigs and same sample id would then benefit from this option being set to True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A dictionary with keys as cell_ids and records as retrieved value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dat_h</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IGH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dat_l</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dat_l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">retrieve_h</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_h</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dat_h</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">],</span> <span class="n">dat_h</span><span class="p">[</span><span class="n">retrieve_id</span><span class="p">])))</span>
        <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">retrieve_h</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;heavy&#39;</span><span class="p">])</span>
        <span class="n">sub_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">heavy_retrieval_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;heavy&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">heavy_retrieval_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                <span class="n">heavy_retrieval_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">to_list</span><span class="p">())])</span>
        <span class="k">return</span><span class="p">(</span><span class="n">heavy_retrieval_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">retrieve_h</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_h</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dat_h</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">],</span> <span class="n">dat_h</span><span class="p">[</span><span class="n">retrieve_id</span><span class="p">])))</span>
        <span class="n">retrieve_l</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dat_l</span><span class="p">[</span><span class="s1">&#39;sequence_id&#39;</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dat_l</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">],</span> <span class="n">dat_l</span><span class="p">[</span><span class="n">retrieve_id</span><span class="p">])))</span>
        <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">retrieve_h</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;heavy&#39;</span><span class="p">])</span>
        <span class="n">sub_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">light_retrieval_tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">retrieve_l</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">light_retrieval_tree</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">light_retrieval_tree2</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">light_retrieval_tree</span><span class="p">:</span>
            <span class="n">second_key</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="n">light_retrieval_tree</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">second_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
            <span class="n">second_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">second_key</span><span class="p">))</span>
            <span class="n">second_key_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">second_key</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">second_key</span><span class="p">))))</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">light_retrieval_tree</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">light_retrieval_tree2</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">second_key_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">light_retrieval_tree2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">else</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;light&#39;</span><span class="p">]])</span>
        <span class="n">tmp_dat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">tmp_dat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;light_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tmp_dat</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp_dat</span><span class="p">,</span> <span class="n">left_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">sub_metadata</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="p">[[</span><span class="s1">&#39;heavy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tmp_dat</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">split_heavy_light</span><span class="p">:</span>
            <span class="n">retrieval_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">collapse</span><span class="p">:</span>
                    <span class="n">r_l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sub_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:])))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r_l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sub_metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">r_l</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">r_l</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">r_l</span> <span class="o">=</span> <span class="n">r_l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">retrieval_list</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">r_l</span><span class="p">])</span>
            <span class="k">return</span><span class="p">(</span><span class="n">retrieval_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">heavy_retrieval_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sub_metadata</span><span class="p">[</span><span class="s1">&#39;heavy&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">heavy_retrieval_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                    <span class="n">heavy_retrieval_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">to_list</span><span class="p">())])</span>
            <span class="n">light_retrieval_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sub_metadata2</span> <span class="o">=</span> <span class="n">sub_metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># TODO: this will come back with issue if some heavy chain comes back with multiple indices that wasn&#39;t filtered</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sub_metadata2</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">collapse</span><span class="p">:</span>
                    <span class="n">r_l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sub_metadata2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:])))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r_l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sub_metadata2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">r_l</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">r_l</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">])</span>
                <span class="n">light_retrieval_list</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span> <span class="k">for</span> <span class="n">zz</span> <span class="ow">in</span> <span class="n">z</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">[</span><span class="n">r_l</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span><span class="p">(</span><span class="n">heavy_retrieval_list</span><span class="p">,</span> <span class="n">light_retrieval_list</span><span class="p">)</span>

<div class="viewcode-block" id="update_metadata"><a class="viewcode-back" href="../../../modules/dandelion.utilities.update_metadata.html#dandelion.utilities.update_metadata">[docs]</a><span class="k">def</span> <span class="nf">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retrieve</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">isotype_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">split_heavy_light</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">collapse</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">clones_sep</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">clone_key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Dandelion function to update and populate the `.metadata` slot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : Dandelion</span>
<span class="sd">        Dandelion object</span>
<span class="sd">    retrieve : str</span>
<span class="sd">        column name in `.data` slot.</span>
<span class="sd">    split_heavy_light : bool</span>
<span class="sd">        Returns the retrieval splitted into two column for heavy and light. Default is True. False combines the retrieval into a single column.</span>
<span class="sd">    collapse : bool</span>
<span class="sd">        Whether or not to collapse unique elements if duplicated. For example, different contigs and same sample id would then benefit from this option being set to True.</span>
<span class="sd">    clones_sep : tuple[int, str]</span>
<span class="sd">        A tuple containing how the clone groups should be extracted. None defaults to (0, &#39;_&#39;).</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dandelion object with `.metadata` slot initialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">,</span> <span class="s1">&#39;umi_count&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span> <span class="p">(</span><span class="s2">&quot;Please check your object. </span><span class="si">%s</span><span class="s2"> is not in the columns of input data.&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">clone_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clonekey</span> <span class="o">=</span> <span class="s1">&#39;clone_id&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clonekey</span> <span class="o">=</span> <span class="n">clone_key</span>

    <span class="n">metadata_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>
    <span class="k">if</span> <span class="n">metadata_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">clonekey</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">setup_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">clonekey</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">setup_metadata_</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="s1">&#39;sample_id&#39;</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">samp_id</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">dat_l</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">dat_l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">heavy_v_call</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># specifying False/True shouldn&#39;t do anything</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">heavy_v_call</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;v_call&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">heavy_j_call</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;j_call&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">heavy_c_call</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">heavy_umi</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;umi_count&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">heavy_status</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">heavy_status</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;heavy&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;heavy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_only&#39;</span>
        <span class="k">if</span> <span class="n">isotype_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conversion_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;igha1&#39;</span><span class="p">:</span><span class="s1">&#39;IgA&#39;</span><span class="p">,</span> <span class="s1">&#39;igha2&#39;</span><span class="p">:</span><span class="s1">&#39;IgA&#39;</span><span class="p">,</span> <span class="s1">&#39;ighm&#39;</span><span class="p">:</span><span class="s1">&#39;IgM&#39;</span><span class="p">,</span> <span class="s1">&#39;ighd&#39;</span><span class="p">:</span><span class="s1">&#39;IgD&#39;</span><span class="p">,</span> <span class="s1">&#39;ighm|ighd&#39;</span><span class="p">:</span><span class="s1">&#39;IgM|IgD&#39;</span><span class="p">,</span> <span class="s1">&#39;ighe&#39;</span><span class="p">:</span><span class="s1">&#39;IgE&#39;</span><span class="p">,</span> <span class="s1">&#39;ighg1&#39;</span><span class="p">:</span><span class="s1">&#39;IgG&#39;</span><span class="p">,</span> <span class="s1">&#39;ighg2&#39;</span><span class="p">:</span><span class="s1">&#39;IgG&#39;</span><span class="p">,</span> <span class="s1">&#39;ighg3&#39;</span><span class="p">:</span><span class="s1">&#39;IgG&#39;</span><span class="p">,</span> <span class="s1">&#39;ighg4&#39;</span><span class="p">:</span><span class="s1">&#39;IgG&#39;</span><span class="p">,</span> <span class="s1">&#39;igkc&#39;</span><span class="p">:</span><span class="s1">&#39;IgK&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc1&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc2&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc3&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc4&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc5&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc6&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc7&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;igha&#39;</span><span class="p">:</span><span class="s1">&#39;IgA&#39;</span><span class="p">,</span> <span class="s1">&#39;ighg&#39;</span><span class="p">:</span><span class="s1">&#39;IgG&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;na&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span> <span class="c1"># the key for IgG being igh is on purpose because of how the counter works</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conversion_dict</span> <span class="o">=</span> <span class="n">isotype_dict</span>
        <span class="n">isotype</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">heavy_c_call</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="c1"># iso_d = defaultdict(int)</span>
                    <span class="c1"># for c in heavy_c_call[k].lower():</span>
                    <span class="c1">#     iso_d[c] += 1</span>
                    <span class="n">isotype</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">[</span><span class="n">conversion_dict</span><span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">isotype</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_dict</span><span class="p">[</span><span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isotype</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">heavy_v_call</span><span class="p">:</span>
            <span class="n">heavy_v_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">heavy_v_call</span><span class="p">[</span><span class="n">k</span><span class="p">]))][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">heavy_j_call</span><span class="p">:</span>
            <span class="n">heavy_j_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">heavy_j_call</span><span class="p">[</span><span class="n">k</span><span class="p">]))][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))])</span>        
        <span class="n">productive</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;sample_id&#39;</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">samp_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;isotype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">isotype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;productive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">productive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;umi_counts_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">heavy_umi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;c_call_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">heavy_c_call</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;v_call_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">heavy_v_call</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;j_call_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">heavy_j_call</span><span class="p">)</span>        
        <span class="n">multi</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hv_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">hv_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hj_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;j_call_heavy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">hj_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;j_call_heavy&#39;</span><span class="p">]</span>            
            <span class="n">multi_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hv_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">multi_</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi_heavy_v&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hj_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">multi_</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi_heavy_j&#39;</span><span class="p">])</span>            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">multi_</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Single&#39;</span><span class="p">])</span>
            <span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">multi_</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;vdj_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">multi</span><span class="p">)</span>
        <span class="c1"># return this in this order</span>
        <span class="k">if</span> <span class="n">metadata_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clonekey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sample_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">,</span> <span class="s1">&#39;isotype&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;vdj_status&#39;</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span>  <span class="s1">&#39;umi_counts_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;c_call_heavy&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">,</span> <span class="s1">&#39;isotype&#39;</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;vdj_status&#39;</span><span class="p">,</span> <span class="s1">&#39;umi_counts_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">,</span><span class="s1">&#39;j_call_heavy&#39;</span><span class="p">,</span><span class="s1">&#39;c_call_heavy&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sample_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="s1">&#39;isotype&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;vdj_status&#39;</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span>  <span class="s1">&#39;umi_counts_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">,</span><span class="s1">&#39;j_call_heavy&#39;</span><span class="p">,</span><span class="s1">&#39;c_call_heavy&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="s1">&#39;isotype&#39;</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;vdj_status&#39;</span><span class="p">,</span> <span class="s1">&#39;umi_counts_heavy&#39;</span><span class="p">,</span>  <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">,</span><span class="s1">&#39;j_call_heavy&#39;</span><span class="p">,</span><span class="s1">&#39;c_call_heavy&#39;</span><span class="p">]]</span>
    
        <span class="c1"># new function to retrieve non-standard columns</span>
        <span class="k">if</span> <span class="n">retrieve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">retrieve</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">retrieve</span> <span class="o">=</span> <span class="p">[</span><span class="n">retrieve</span><span class="p">]</span>                
            <span class="k">for</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">retrieve</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>                                    
                    <span class="n">retrieve_dict</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">retrieve_dict</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Unknown column : </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> to retrieve.&#39;</span> <span class="o">%</span> <span class="n">ret</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;v_call_genotyped&#39;</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">heavy_v_call</span><span class="p">,</span> <span class="n">light_v_call</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;v_call_genotyped&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">heavy_v_call</span><span class="p">,</span> <span class="n">light_v_call</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;v_call&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">heavy_j_call</span><span class="p">,</span> <span class="n">light_j_call</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;j_call&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">heavy_c_call</span><span class="p">,</span> <span class="n">light_c_call</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;c_call&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">heavy_umi</span><span class="p">,</span> <span class="n">light_umi</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;umi_count&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">heavy_status</span><span class="p">,</span> <span class="n">light_status</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;locus&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">heavy_status</span><span class="p">,</span> <span class="n">light_status</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;light&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;heavy&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; + &#39;</span><span class="o">+</span><span class="n">status</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;light&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">status</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;heavy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_only&#39;</span>
        <span class="k">if</span> <span class="n">isotype_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conversion_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;igha1&#39;</span><span class="p">:</span><span class="s1">&#39;IgA&#39;</span><span class="p">,</span> <span class="s1">&#39;igha2&#39;</span><span class="p">:</span><span class="s1">&#39;IgA&#39;</span><span class="p">,</span> <span class="s1">&#39;ighm&#39;</span><span class="p">:</span><span class="s1">&#39;IgM&#39;</span><span class="p">,</span> <span class="s1">&#39;ighd&#39;</span><span class="p">:</span><span class="s1">&#39;IgD&#39;</span><span class="p">,</span> <span class="s1">&#39;ighm|ighd&#39;</span><span class="p">:</span><span class="s1">&#39;IgM|IgD&#39;</span><span class="p">,</span> <span class="s1">&#39;ighe&#39;</span><span class="p">:</span><span class="s1">&#39;IgE&#39;</span><span class="p">,</span> <span class="s1">&#39;ighg1&#39;</span><span class="p">:</span><span class="s1">&#39;IgG&#39;</span><span class="p">,</span> <span class="s1">&#39;ighg2&#39;</span><span class="p">:</span><span class="s1">&#39;IgG&#39;</span><span class="p">,</span> <span class="s1">&#39;ighg3&#39;</span><span class="p">:</span><span class="s1">&#39;IgG&#39;</span><span class="p">,</span> <span class="s1">&#39;ighg4&#39;</span><span class="p">:</span><span class="s1">&#39;IgG&#39;</span><span class="p">,</span> <span class="s1">&#39;igkc&#39;</span><span class="p">:</span><span class="s1">&#39;IgK&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc1&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc2&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc3&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc4&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc5&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc6&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc7&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;igha&#39;</span><span class="p">:</span><span class="s1">&#39;IgA&#39;</span><span class="p">,</span> <span class="s1">&#39;ighg&#39;</span><span class="p">:</span><span class="s1">&#39;IgG&#39;</span><span class="p">,</span> <span class="s1">&#39;iglc&#39;</span><span class="p">:</span><span class="s1">&#39;IgL&#39;</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;na&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span> <span class="c1"># the key for IgG being igh is on purpose because of how the counter works</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conversion_dict</span> <span class="o">=</span> <span class="n">isotype_dict</span>
        <span class="n">isotype</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">heavy_c_call</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="c1"># iso_d = defaultdict(int)</span>
                    <span class="c1"># for c in heavy_c_call[k].lower():</span>
                    <span class="c1">#     iso_d[c] += 1</span>
                    <span class="n">isotype</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">[</span><span class="n">conversion_dict</span><span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">isotype</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_dict</span><span class="p">[</span><span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isotype</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">heavy_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">lightchain</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">light_c_call</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">light_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">light_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">light_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">light_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">lc_y</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">light_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">):</span>
                            <span class="n">iso_d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                                <span class="n">iso_d</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">lc_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;,|[0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k_</span> <span class="k">for</span> <span class="n">k_</span><span class="p">,</span><span class="n">v_</span> <span class="ow">in</span> <span class="n">iso_d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v_</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])))</span>
                            <span class="n">lc_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;,|[0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k_</span> <span class="k">for</span> <span class="n">k_</span><span class="p">,</span><span class="n">v_</span> <span class="ow">in</span> <span class="n">iso_d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v_</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">])))</span>
                        <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">lc_y</span><span class="p">:</span>
                            <span class="n">lc_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lc_y</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                        <span class="n">lightchain</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">conversion_dict</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">lc_y</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lightchain</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">[</span><span class="n">conversion_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">light_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">light_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">iso_d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">light_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">iso_d</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">lightchain</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_dict</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;,|[0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k_</span> <span class="k">for</span> <span class="n">k_</span><span class="p">,</span><span class="n">v_</span> <span class="ow">in</span> <span class="n">iso_d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v_</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">]))]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lightchain</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_dict</span><span class="p">[</span><span class="n">light_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lightchain</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">light_c_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">heavy_v_call</span><span class="p">:</span>
            <span class="n">heavy_v_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">heavy_v_call</span><span class="p">[</span><span class="n">k</span><span class="p">]))][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">heavy_j_call</span><span class="p">:</span>
            <span class="n">heavy_j_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">heavy_j_call</span><span class="p">[</span><span class="n">k</span><span class="p">]))][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">light_v_call</span><span class="p">:</span>
            <span class="n">light_v_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">light_v_call</span><span class="p">[</span><span class="n">k</span><span class="p">]))][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">light_j_call</span><span class="p">:</span>
            <span class="n">light_j_call</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[*][0-9][0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">light_j_call</span><span class="p">[</span><span class="n">k</span><span class="p">]))][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))])</span>
        <span class="n">productive</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;sample_id&#39;</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">samp_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;isotype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">isotype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;lightchain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">lightchain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;productive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">productive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;umi_counts_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">heavy_umi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;umi_counts_light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">light_umi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;c_call_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">heavy_c_call</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;c_call_light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">light_c_call</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;v_call_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">heavy_v_call</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;v_call_light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">light_v_call</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;j_call_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">heavy_j_call</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;j_call_light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">light_j_call</span><span class="p">)</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hv_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">hv_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hj_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;j_call_heavy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">hj_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;j_call_heavy&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lv_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call_light&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">lv_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call_light&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lj_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call_light&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">lv_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;v_call_light&#39;</span><span class="p">]</span>
            <span class="n">multi_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hv_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">multi_</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi_heavy_v&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hj_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">multi_</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi_heavy_j&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lv_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">multi_</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi_light_v&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lj_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">multi_</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Multi_light_j&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">multi_</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Single&#39;</span><span class="p">])</span>
            <span class="n">multi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">multi_</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;vdj_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">multi</span><span class="p">)</span>
        <span class="c1"># return this in this order</span>
        <span class="k">if</span> <span class="n">metadata_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clonekey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sample_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">,</span> <span class="s1">&#39;isotype&#39;</span><span class="p">,</span> <span class="s1">&#39;lightchain&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;vdj_status&#39;</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span>  <span class="s1">&#39;umi_counts_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;umi_counts_light&#39;</span><span class="p">,</span> <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;v_call_light&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call_light&#39;</span><span class="p">,</span> <span class="s1">&#39;c_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;c_call_light&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clonekey</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_by_size&#39;</span><span class="p">,</span> <span class="s1">&#39;isotype&#39;</span><span class="p">,</span> <span class="s1">&#39;lightchain&#39;</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;vdj_status&#39;</span><span class="p">,</span> <span class="s1">&#39;umi_counts_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;umi_counts_light&#39;</span><span class="p">,</span>  <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;v_call_light&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call_light&#39;</span><span class="p">,</span> <span class="s1">&#39;c_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;c_call_light&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sample_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="s1">&#39;sample_id&#39;</span><span class="p">,</span> <span class="s1">&#39;isotype&#39;</span><span class="p">,</span> <span class="s1">&#39;lightchain&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;vdj_status&#39;</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span>  <span class="s1">&#39;umi_counts_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;umi_counts_light&#39;</span><span class="p">,</span> <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;v_call_light&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call_light&#39;</span><span class="p">,</span> <span class="s1">&#39;c_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;c_call_light&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="s1">&#39;isotype&#39;</span><span class="p">,</span> <span class="s1">&#39;lightchain&#39;</span><span class="p">,</span> <span class="s1">&#39;productive&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;vdj_status&#39;</span><span class="p">,</span> <span class="s1">&#39;umi_counts_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;umi_counts_light&#39;</span><span class="p">,</span>  <span class="s1">&#39;v_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;v_call_light&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;j_call_light&#39;</span><span class="p">,</span> <span class="s1">&#39;c_call_heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;c_call_light&#39;</span><span class="p">]]</span>
        <span class="c1"># new function to retrieve non-standard columns</span>
        <span class="k">if</span> <span class="n">retrieve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">retrieve</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">retrieve</span> <span class="o">=</span> <span class="p">[</span><span class="n">retrieve</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">retrieve</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">split_heavy_light</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">collapse</span><span class="p">:</span>
                            <span class="n">retrieve_dict</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">retrieve_dict</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ret</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">retrieve_dict</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">collapse</span><span class="p">:</span>
                            <span class="n">h_retrieve_dict</span><span class="p">,</span> <span class="n">l_retrieve_dict</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">h_retrieve_dict</span><span class="p">,</span> <span class="n">l_retrieve_dict</span> <span class="o">=</span> <span class="n">retrieve_metadata</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_heavy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">h_retrieve_dict</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_light&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">l_retrieve_dict</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Unknown column : </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> to retrieve.&#39;</span> <span class="o">%</span> <span class="n">ret</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dandelion"><a class="viewcode-back" href="../../../modules/dandelion.utilities.Dandelion.html#dandelion.utilities.Dandelion">[docs]</a><span class="k">class</span> <span class="nc">Dandelion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dandelion class object.</span>

<span class="sd">    Main class object storing input/ouput slots for all functions.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Dandelion.__init__"><a class="viewcode-back" href="../../../modules/dandelion.utilities.Dandelion.html#dandelion.utilities.Dandelion.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">germline</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">germline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">germline</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_contigs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">initialize</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">update_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_contigs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="k">def</span> <span class="nf">_gen_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">n_contigs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Dandelion class object with n_obs = </span><span class="si">{</span><span class="n">n_obs</span><span class="si">}</span><span class="s2"> and n_contigs = </span><span class="si">{</span><span class="n">n_contigs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">,</span> <span class="s2">&quot;edges&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    layout: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;layout for &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; vertices&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    layout: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    graph: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;networkx graph of &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; vertices&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    graph: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">descr</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_contigs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a deep copy of all slots in `dandelion` class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self : Dandelion</span>
<span class="sd">            Dandelion object.        </span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        a deep copy of `dandelion` class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_germline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corrected</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">germline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">org</span> <span class="o">=</span> <span class="s1">&#39;human&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update germline reference with corrected sequences and store in Dandelion object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self : Dandelion</span>
<span class="sd">            Dandelion object.</span>
<span class="sd">        corrected : dict, str, optional</span>
<span class="sd">            dictionary of corrected germline sequences or file path to corrected germline sequences fasta file.</span>
<span class="sd">        germline : str, optional</span>
<span class="sd">            path to germline database folder. Defaults to `$GERMLINE` environmental variable.</span>
<span class="sd">        org : str</span>
<span class="sd">            organism of reference folder. Default is &#39;human&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        updated germline reference diciontary in `.germline` slot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating germline reference&#39;</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">germline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gml</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;GERMLINE&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Environmental variable GERMLINE must be set. Otherwise, please provide path to folder containing germline IGHV, IGHD, and IGHJ fasta files.&#39;</span><span class="p">)</span>
            <span class="n">gml</span> <span class="o">=</span> <span class="n">gml</span><span class="o">+</span><span class="s1">&#39;imgt/&#39;</span><span class="o">+</span><span class="n">org</span><span class="o">+</span><span class="s1">&#39;/vdj/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">germline</span><span class="p">):</span>
                <span class="n">gml</span> <span class="o">=</span> <span class="n">germline</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">germline</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">germline_</span> <span class="o">=</span> <span class="p">[</span><span class="n">germline</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">germline_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Input for germline is incorrect. Please provide path to folder containing germline IGHV, IGHD, and IGHJ fasta files, or individual paths to the germline IGHV, IGHD, and IGHJ fasta files (with .fasta extension) as a list.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gml</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">germline_</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Input for germline is incorrect. Please provide path to folder containing germline IGHV, IGHD, and IGHJ fasta files, or individual paths to the germline IGHV, IGHD, and IGHJ fasta files (with .fasta extension) as a list.&#39;</span><span class="p">)</span>
                        <span class="n">gml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">germline</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">germline</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Input for germline is incorrect. Please provide path to folder containing germline IGHV, IGHD, and IGHJ fasta files, or individual paths to the germline IGHV, IGHD, and IGHJ fasta files (with .fasta extension) as a list.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gml</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">germline</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fasta&#39;</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Input for germline is incorrect. Please provide path to folder containing germline IGHV, IGHD, and IGHJ fasta files, or individual paths to the germline IGHV, IGHD, and IGHJ fasta files (with .fasta extension) as a list.&#39;</span><span class="p">)</span>
                        <span class="n">gml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">gml</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">gml</span> <span class="o">=</span> <span class="p">[</span><span class="n">gml</span><span class="p">]</span>

        <span class="n">germline_ref</span> <span class="o">=</span> <span class="n">readGermlines</span><span class="p">(</span><span class="n">gml</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">corrected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">corrected</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">personalized_ref_dict</span> <span class="o">=</span> <span class="n">corrected</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">corrected</span><span class="p">)):</span>
                <span class="n">personalized_ref_dict</span> <span class="o">=</span> <span class="n">readGermlines</span><span class="p">([</span><span class="n">corrected</span><span class="p">])</span>
            <span class="c1"># update with the personalized germline database</span>
            <span class="k">if</span> <span class="s1">&#39;personalized_ref_dict&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="n">germline_ref</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">personalized_ref_dict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Input for corrected germline fasta is incorrect. Please provide path to file containing corrected germline fasta sequences.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">germline_ref</span><span class="p">)</span>
        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; finished&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
        <span class="n">deep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Updated Dandelion object: </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;   </span><span class="se">\&#39;</span><span class="s1">germline</span><span class="se">\&#39;</span><span class="s1">, updated germline reference</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">write_pkl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;dandelion_data.pkl.pbz2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a `Dandelion` class to .pkl format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename</span>
<span class="sd">            path to Dandelion `.pkl` file.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            passed to `_pickle`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isBZIP</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">isGZIP</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;dandelion_data.h5&#39;</span><span class="p">,</span> <span class="n">complib</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">compression_level</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a `Dandelion` class to .h5 format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename</span>
<span class="sd">            path to Dandelion `.h5` file.</span>
<span class="sd">        complib : str, optional</span>
<span class="sd">            method for compression for data frames. see (https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_hdf.html) for more options.</span>
<span class="sd">        compression : str, optional</span>
<span class="sd">            same call as complib. Just a convenience option.</span>
<span class="sd">        compression_opts : {0-9}, optional</span>
<span class="sd">            Specifies a compression level for data. A value of 0 disables compression.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            passed to `pd.DataFrame.to_hdf`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">compression_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">compression_level</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compression_level</span> <span class="o">=</span> <span class="n">compression_level</span>

        <span class="c1"># a little hack to overwrite the existing file?</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>  <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">datasetname</span> <span class="ow">in</span> <span class="n">hf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">hf</span><span class="p">[</span><span class="n">datasetname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">complib</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compression</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">complib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compression</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">complib</span>
        <span class="k">elif</span> <span class="n">complib</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">compression</span>
        <span class="k">if</span> <span class="n">complib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please specify only complib or compression. They do the same thing.&#39;</span><span class="p">)</span>

        <span class="c1"># now to actually saving</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">weird</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">type</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">weird</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">complib</span> <span class="o">=</span> <span class="n">comp</span><span class="p">,</span> <span class="n">complevel</span> <span class="o">=</span> <span class="n">compression_level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>                
                <span class="n">weird</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">type</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">weird</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="n">complib</span> <span class="o">=</span> <span class="n">comp</span><span class="p">,</span> <span class="n">complevel</span> <span class="o">=</span> <span class="n">compression_level</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="n">nan_rep</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     warnings.warn(&quot;`metadata` slot not saved. Please check if there is incompatible dtypes in the metadata table.&quot;)</span>
        <span class="c1">#     pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="n">complib</span> <span class="o">=</span> <span class="n">comp</span><span class="p">,</span> <span class="n">complevel</span> <span class="o">=</span> <span class="n">compression_level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">graph_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">:</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">to_pandas_adjacency</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">nonedge</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">G</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;graph/graph_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">graph_counter</span><span class="p">),</span> <span class="n">complib</span> <span class="o">=</span> <span class="n">comp</span><span class="p">,</span> <span class="n">complevel</span> <span class="o">=</span> <span class="n">compression_level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">graph_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span> <span class="c1"># how to make this faster?</span>
                <span class="n">dat</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;distance/&quot;</span><span class="o">+</span><span class="n">d</span><span class="p">,</span> <span class="n">complib</span> <span class="o">=</span> <span class="n">comp</span><span class="p">,</span> <span class="n">complevel</span> <span class="o">=</span> <span class="n">compression_level</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>  <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
            <span class="c1"># try:</span>
            <span class="c1">#     for d in self.distance:</span>
            <span class="c1">#         hf.create_dataset(&#39;distance/&#39;+d+&#39;/data&#39;, data=self.distance[d].data, compression = compression, compression_opts = compression_level)</span>
            <span class="c1">#         hf.create_dataset(&#39;distance/&#39;+d+&#39;/indptr&#39;, data=self.distance[d].indptr, compression = compression, compression_opts = compression_level)</span>
            <span class="c1">#         hf.create_dataset(&#39;distance/&#39;+d+&#39;/indices&#39;, data=self.distance[d].indices, compression = compression, compression_opts = compression_level)</span>
            <span class="c1">#         hf[&#39;distance/&#39;+d].attrs[&#39;shape&#39;] = self.distance[d].shape</span>
            <span class="c1"># except:</span>
            <span class="c1">#     pass</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">layout_counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;layout/layout_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">layout_counter</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;layout/layout_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">layout_counter</span><span class="p">)]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">layout_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;germline&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;germline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">germline</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">tr</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">isGZIP</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gz&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">isBZIP</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pbz2&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="read_pkl"><a class="viewcode-back" href="../../../modules/dandelion.utilities.read_pkl.html#dandelion.utilities.read_pkl">[docs]</a><span class="k">def</span> <span class="nf">read_pkl</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;dandelion_data.pkl.pbz2&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in and returns a `Dandelion` class saved using pickle format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename</span>
<span class="sd">        path to Dandelion `.pkl` file. Depending on the extension, it will try to unzip accordingly.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dandelion object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">isBZIP</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">isGZIP</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="read_h5"><a class="viewcode-back" href="../../../modules/dandelion.utilities.read_h5.html#dandelion.utilities.read_h5">[docs]</a><span class="k">def</span> <span class="nf">read_h5</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;dandelion_data.h5&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in and returns a `Dandelion` class from .h5 format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename</span>
<span class="sd">        path to Dandelion `.h5` file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dandelion object.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not contain attribute `data`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;edges&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">g_0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;graph/graph_0&#39;</span><span class="p">)</span>
        <span class="n">g_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;graph/graph_1&#39;</span><span class="p">)</span>
        <span class="n">g_0</span> <span class="o">=</span> <span class="n">g_0</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">g_0</span> <span class="o">=</span> <span class="n">g_0</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">g_1</span> <span class="o">=</span> <span class="n">g_1</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">g_1</span> <span class="o">=</span> <span class="n">g_1</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">graph0</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_pandas_adjacency</span><span class="p">(</span><span class="n">g_0</span><span class="p">)</span>
        <span class="n">graph1</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_pandas_adjacency</span><span class="p">(</span><span class="n">g_1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">graph0</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">graph1</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="p">(</span><span class="n">graph0</span><span class="p">,</span> <span class="n">graph1</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">layout0</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;layout/layout_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">layout0</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hf</span><span class="p">[</span><span class="s1">&#39;layout/layout_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">])})</span>
            <span class="n">layout1</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;layout/layout_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">layout1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hf</span><span class="p">[</span><span class="s1">&#39;layout/layout_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">])})</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="p">(</span><span class="n">layout0</span><span class="p">,</span> <span class="n">layout1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    
        <span class="n">germline</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;germline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">germline</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">g</span><span class="p">:</span><span class="n">hf</span><span class="p">[</span><span class="s1">&#39;germline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">g</span><span class="p">]})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    
        <span class="n">distance</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">d_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;distance/&#39;</span><span class="o">+</span><span class="n">d</span><span class="p">)</span>
                <span class="n">distance</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">d_</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="c1"># d_ = hf[&#39;distance&#39;][d]</span>
                <span class="c1"># distance[d] = scipy.sparse.csr_matrix((d_[&#39;data&#39;][:],d_[&#39;indices&#39;][:], d_[&#39;indptr&#39;][:]), d_.attrs[&#39;shape&#39;])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    
        <span class="k">try</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hf</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">constructor</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">constructor</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">if</span> <span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="n">constructor</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    <span class="k">if</span> <span class="s1">&#39;germline&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="n">constructor</span><span class="p">[</span><span class="s1">&#39;germline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">germline</span>
    <span class="k">if</span> <span class="s1">&#39;edges&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="n">constructor</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span>
    <span class="k">if</span> <span class="s1">&#39;distance&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="n">constructor</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span>
    <span class="k">if</span> <span class="s1">&#39;layout&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="n">constructor</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layout</span>
    <span class="k">if</span> <span class="s1">&#39;graph&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="n">constructor</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="o">**</span><span class="n">constructor</span><span class="p">)</span>        
    <span class="k">except</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="o">**</span><span class="n">constructor</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;threshold&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="n">res</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">check_unique</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenate dataframe and return as Dandelion object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arrays</span>
<span class="sd">        pandas dataframe or file path</span>
<span class="sd">    columns</span>
<span class="sd">        column names in dataframe</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sample_dict</span>
<span class="sd">        dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arrays</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>
    <span class="n">arrays_</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">check_unique</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">arrays_</span><span class="p">,</span> <span class="n">verify_integrity</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">arrays_</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Dandelion</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<span class="c1"># def convert_preprocessed_tcr_10x(file, prefix = None):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     file : str</span>
<span class="c1">#         file path to .tsv file.</span>
<span class="c1">#     prefix : str</span>
<span class="c1">#         prefix to add to barcodes. Ignored if left as None.    </span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     from tqdm import tqdm</span>
<span class="c1">#     import re</span>
<span class="c1">#     cr_annot = pd.read_csv(file)</span>
<span class="c1">#     if prefix is not None:</span>
<span class="c1">#         cr_annot[&#39;index&#39;]=[prefix+&#39;_&#39;+i for i in cr_annot[&#39;contig_id&#39;]]</span>
<span class="c1">#     else:</span>
<span class="c1">#         cr_annot[&#39;index&#39;]=[i for i in cr_annot[&#39;contig_id&#39;]]</span>
<span class="c1">#     cr_annot.set_index(&#39;index&#39;, inplace = True)</span>

<span class="c1">#     ddl_annot = load_data(&quot;{}/tmp/{}_igblast_db-pass.tsv&quot;.format(os.path.dirname(file), os.path.basename(file).split(&#39;_annotations.csv&#39;)[0]))</span>

<span class="c1">#     for i in tqdm(ddl_annot.index, desc = &#39;Processing data &#39;):</span>
<span class="c1">#         v = ddl_annot.loc[i, &#39;v_call&#39;]</span>
<span class="c1">#         d = ddl_annot.loc[i, &#39;d_call&#39;]</span>
<span class="c1">#         j = ddl_annot.loc[i, &#39;j_call&#39;]</span>
<span class="c1">#         if v is not np.nan:</span>
<span class="c1">#             ddl_annot.at[i, &#39;v_call_igblast&#39;] = &#39;,&#39;.join(list(set(re.sub(&#39;[*][0-9][0-9]&#39;, &#39;&#39;, v).split(&#39;,&#39;))))</span>
<span class="c1">#             v_ = list(set(re.sub(&#39;[*][0-9][0-9]&#39;, &#39;&#39;, v).split(&#39;,&#39;)))</span>
<span class="c1">#             if re.match(&#39;IGH&#39;, &#39;,&#39;.join(v_)):</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;IGH&#39;</span>
<span class="c1">#             if re.match(&#39;IGK&#39;, &#39;,&#39;.join(v_)):</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;IGK&#39;</span>
<span class="c1">#             if re.match(&#39;IGL&#39;, &#39;,&#39;.join(v_)):</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;IGL&#39;</span>
<span class="c1">#             if len(v_) &gt; 1:</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;Multi&#39;</span>
<span class="c1">#         if d is not np.nan:</span>
<span class="c1">#             ddl_annot.at[i, &#39;d_call_igblast&#39;] = &#39;,&#39;.join(list(set(re.sub(&#39;[*][0-9][0-9]&#39;, &#39;&#39;, d).split(&#39;,&#39;))))</span>
<span class="c1">#             d_ = list(set(re.sub(&#39;[*][0-9][0-9]&#39;, &#39;&#39;, d).split(&#39;,&#39;)))</span>
<span class="c1">#             if re.match(&#39;IGH&#39;, &#39;,&#39;.join(d_)):</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;IGH&#39;</span>
<span class="c1">#             if re.match(&#39;IGK&#39;, &#39;,&#39;.join(d_)):</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;IGK&#39;</span>
<span class="c1">#             if re.match(&#39;IGL&#39;, &#39;,&#39;.join(d_)):</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;IGL&#39;</span>
<span class="c1">#             if len(d_) &gt; 1:</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;Multi&#39;</span>
<span class="c1">#         if j is not np.nan:</span>
<span class="c1">#             ddl_annot.at[i, &#39;j_call_igblast&#39;] = &#39;,&#39;.join(list(set(re.sub(&#39;[*][0-9][0-9]&#39;, &#39;&#39;, j).split(&#39;,&#39;))))</span>
<span class="c1">#             j_ = list(set(re.sub(&#39;[*][0-9][0-9]&#39;, &#39;&#39;, j).split(&#39;,&#39;)))</span>
<span class="c1">#             if re.match(&#39;IGH&#39;, &#39;,&#39;.join(j_)):</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;IGH&#39;</span>
<span class="c1">#             if re.match(&#39;IGK&#39;, &#39;,&#39;.join(j_)):</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;IGK&#39;</span>
<span class="c1">#             if re.match(&#39;IGL&#39;, &#39;,&#39;.join(j_)):</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;IGL&#39;</span>
<span class="c1">#             if len(j_) &gt; 1:</span>
<span class="c1">#                 ddl_annot.at[i, &#39;locus&#39;] = &#39;Multi&#39;</span>

<span class="c1">#     cellrangermap = {</span>
<span class="c1">#         &#39;sequence_id&#39;:&#39;contig_id&#39;,</span>
<span class="c1">#         &#39;locus&#39;:&#39;chain&#39;,</span>
<span class="c1">#         &#39;v_call_igblast&#39;:&#39;v_gene&#39;,</span>
<span class="c1">#         &#39;d_call_igblast&#39;:&#39;d_gene&#39;,</span>
<span class="c1">#         &#39;j_call_igblast&#39;:&#39;j_gene&#39;,</span>
<span class="c1">#         &#39;productive&#39;:&#39;productive&#39;,</span>
<span class="c1">#         &#39;junction_aa&#39;:&#39;cdr3&#39;,</span>
<span class="c1">#         &#39;junction&#39;:&#39;cdr3_nt&#39;}</span>

<span class="c1">#     for i in tqdm(cr_annot.index, desc = &#39;Matching and updating contig ids&#39;):</span>
<span class="c1">#         if i in ddl_annot.index:</span>
<span class="c1">#             for key, value in cellrangermap.items():</span>
<span class="c1">#                 if cr_annot.loc[i, &#39;chain&#39;] not in [&#39;IGH&#39;, &#39;IGK&#39;, &#39;IGL&#39;, None]:</span>
<span class="c1">#                     cr_annot.at[i, value] = ddl_annot.loc[i, key]</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     cr_annot.at[i, &#39;contig_id&#39;] = ddl_annot.loc[i, &#39;sequence_id&#39;]</span>

<span class="c1">#             if cr_annot.loc[i, &#39;cdr3&#39;] is np.nan:</span>
<span class="c1">#                 cr_annot.at[i, &#39;productive&#39;] = None</span>
<span class="c1">#             else:</span>
<span class="c1">#                 if cr_annot.loc[i, &#39;productive&#39;] == &#39;T&#39;:</span>
<span class="c1">#                     cr_annot.at[i, &#39;productive&#39;] = &#39;True&#39;</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     cr_annot.at[i, &#39;productive&#39;] = &#39;False&#39;</span>
<span class="c1">#     cr_annot.to_csv(&quot;{}/{}_annotations_reannotated.csv&quot;.format(os.path.dirname(file), os.path.basename(file).split(&#39;_annotations.csv&#39;)[0]), index = False, na_rep = &#39;None&#39;)</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, zktuong

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>